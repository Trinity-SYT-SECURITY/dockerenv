# Zabbix Enviroment for CVE-2022-23131

In the case of instances where the SAML SSO authentication is enabled (non-default), session data can be modified by a malicious actor, because a user login stored in the session was not verified.

## Affected Version

|      CVE     | Range |
|--------------|-----------|
| CVE-2022-23131 | [5.4.0, 5.4.8] 6.0.0alpha1 |

## Usage

Run following command to startup the zabbix

```bash
docker-compose up
```

## Configure SAML SSO for Zabbix

**Remeber, this step is a little bit tedious, and I have no way to auto-configure it right now.**

In this case, we use [keycloak](https://www.keycloak.org/) as the SSO server for `Zabbix`.

### Step 1 Create the crt file from IDP metadata

Access `http://localhost:8080` with your brower, and login `keycloak` with

```
username: admin
password: admin
```

> We use default relam (`Master`) here.

Now, access the `http://localhost:8080/realms/master/protocol/saml/descriptor`, or you can access this url by

```
Main Page -> Realm Settings -> General -> Endpoints -> click `SAML 2.0 Identify Provider Metadata`
```

Attach a shell to the container with

```bash
docker exec -it <container id of zabbix-web-nginx-mysql> bash
```

Create a file with name `ipd.crt` in `/usr/share/zabbix/conf/certs/`

Copy the content you got form the above site to this file

```
# ipd.crt
-----BEGIN CERTIFICATE-----
MIICmzCCAYMCBgF/JJOOhjANBgkqhkiG9w0BAQsFADARMQ8wDQYDVQQDDAZtYXN0ZXIwHhcNMjIwMjIzMDMxMzQ0WhcNMzIwMjIzMDMxNTI0WjARMQ8wDQYDVQQDDAZtYXN0ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCL1T8CsrR/rfww9fwmcvvbbNQRgxD/62VzjNWkwbgweNPrWIJRQ8/3Ijculbo+b/B/4/c+3D71dM8lWhaGLED7N6xxm9GaENMtheidP+6uVUQ12jVmOXoHcEoVwQbtUBQaXnKG2spianfhjMbbORVH9RAqCFCjODPqUiseQExhK8tQOc9816AYKEY8x/0Byqpn6JkHUmEdEEBF1eA2yMv+R7PxRoQt3NPSc1OjXR/eCGNbpTNVUoQQ2DlmRMyfyYrdj/UHl9RnY3jk9uH8Lj9pefJK+T+rvQhrk8ufyPOzydw0ubIOE8Acduu6oX+S56cGVgkLfS3ZKysdzW0QCvebAgMBAAEwDQYJKoZIhvcNAQELBQADggEBADnDXW7u/BANVDBxMK5/NJQCxTxsxriNLJEYFEEiVhqr6EE5mmgGUnS+qED29r0bS37zGcbDPQ+Y7kZCBHJmWJytmwOQ7vpCbVvyu3r4CVrlywXJqNLCt8atHbxDRTgNIlazdFXnUixEWmQNgXlOCBOcsmU2y3DdB19VOJtFZAa61g9VFQeBBzbzpQ2d0MxJHA0rtOrsLNcgQrXH/eyP73zY/xIgOU+7rqa5IHXrhlKbiHGsTk7WKtnh/CvgLh+2g6kFbpdIblatAi9TE68e8H0Cty6Q+1Cj1qI1KWhZNA63qaE/wwB5b9s7Wr6/GKcelVfUmCQksX0aE4ljqDJDxiY=
-----END CERTIFICATE-----
```

and run

```bash
chmod 644 idp.crt
chmod +x idp.crt
```

### Step 2 Create A Client in Keycloak

Back to main page and click `Client` on left side bar. Create a new client

```
Client ID: zabbix
Client Protocol: saml
```

and save.

After that, configure the client with

```
Master SAML Processing URL: http://localhost/zabbix/index_sso.php?acs
Valid Redirect URIs: http://localhost/zabbix/*
```

Open `Fine Grain SAML Endpoint Configuration`

```
Logout Service Redirect Binding URL: http://localhost/zabbix/index_sso.php?sls
```



# Reference

1. https://support.zabbix.com/browse/ZBX-20350
